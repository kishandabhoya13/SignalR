@{
}
@model ChatMessage
<h2>WebSocket Chat Application</h2>
<br />
<h3>@Model.Username Chat with HOD @Model.ReceiverUsername</h3>
<div class="message-main-div">
    <div class="message-div">
        <ul id="messagesList"></ul>
        <input type="text" id="messageInput" placeholder="Write a message..." onkeypress="handleKeyPress(event)" />
        <button id="sendButton" onclick="sendMessage()">Send</button>
    </div>
</div>

<script>
    let socket;
    const username = "@Model.Username";
    const receiverUsername = "@Model.ReceiverUsername";
    console.log("Username ::::: ", username);
    console.log("Receiver Username ::::: ", receiverUsername);
    init();
    function init() {
        socket = new WebSocket('wss://localhost:7137/ws');
        socket.onopen = () => {
            console.log('WebSocket connection established.');

            // Send an initial message to register the username
            const initMessage = {
                Username: username,
                //ReceiverUsername: "@Model.ReceiverUsername",
                message: `${username} has joined the chat!`
            };
            socket.send(JSON.stringify(initMessage));
        };

        socket.onmessage = (event) => {
            const messagesList = document.getElementById('messagesList');
            const msgData = JSON.parse(event.data);
            console.log("MEssage data : ", msgData);

            console.log("receiver Username :::", receiverUsername);
            console.log("Username :::", msgData);
            if (receiverUsername == msgData.Username && username == msgData.ReceiverUsername) {
                const li = document.createElement('li');
                li.className = 'message received';
                li.textContent = `${receiverUsername} : ${msgData.Message}`;

                const now = new Date();
                const formattedDateTime = now.toLocaleString();

                const dateSpan = document.createElement('span');
                dateSpan.className = 'message-date';
                dateSpan.textContent = formattedDateTime;

                li.appendChild(dateSpan);

                messagesList.appendChild(li);
                messagesList.scrollTop = messagesList.scrollHeight;
            }

        };

        socket.onclose = () => {
            console.log('WebSocket connection closed.');
        };
    }

    function sendMessage() {
        const messageInput = document.getElementById('messageInput');
        const message = {
            ReceiverUsername: "@Model.ReceiverUsername",
            Username: username,
            message: messageInput.value
        };

        socket.send(JSON.stringify(message));
        const li = document.createElement('li');
        li.className = 'message sent';
        li.textContent = `${username}: ${messageInput.value}`;

        const now = new Date();
        const formattedDateTime = now.toLocaleString();

        const dateSpan = document.createElement('span');
        dateSpan.className = 'message-date';
        dateSpan.textContent = formattedDateTime;

        li.appendChild(dateSpan);


        document.getElementById('messagesList').appendChild(li);
        messageInput.value = '';
        document.getElementById('messagesList').scrollTop = document.getElementById('messagesList').scrollHeight;
    }

    function handleKeyPress(event) {
        if (event.key === 'Enter') {
            console.log("presss");
            event.preventDefault();
            sendMessage();
        }
    }
</script>